name: AI Changelog Generator (Gemini Free)

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-changelog:
    name: Generate AI Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR information
        id: pr_info
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_REF: origin/${{ github.base_ref }}
        run: |
          # 1. Get Commit Messages (Limit 15)
          COMMITS=$(git log $BASE_REF..HEAD --pretty=format:"- %s" --no-merges | head -15)
          
          # 2. Get Changed Files (Limit 15)
          CHANGED_FILES=$(git diff --name-only $BASE_REF...HEAD | head -15)
          
          # 3. Get Actual Diff (Limit 10k chars for Gemini)
          # Exclude lockfiles to save space
          RAW_DIFF=$(git diff $BASE_REF...HEAD -- . ':(exclude)package-lock.json' ':(exclude)*.lock')
          DIFF=$(echo "$RAW_DIFF" | head -c 10000)

          if [ -z "$COMMITS" ]; then COMMITS="No commit messages found."; fi

          # Safe output to GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog with Gemini
        id: ai_changelog
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_TITLE: ${{ steps.pr_info.outputs.pr_title }}
          PR_FILES: ${{ steps.pr_info.outputs.changed_files }}
          PR_COMMITS: ${{ steps.pr_info.outputs.commits }}
          PR_DIFF: ${{ steps.pr_info.outputs.diff }}
        run: |
          # 1. Prepare Prompt Content
          PROMPT_CONTENT=$(cat <<END_PROMPT
          You are a senior technical writer.
          Task: Write a concise changelog based on the provided Code Diff and Commits.
          
          Context:
          - PR Title: $PR_TITLE
          - Files: 
          $PR_FILES
          - Commits: 
          $PR_COMMITS
          
          CODE DIFF:
          $PR_DIFF
          
          Strict Rules:
          1. Do NOT hallucinate features.
          2. If the diff is only CI/CD, summarize as 'Internal CI improvements'.
          3. Format:
             ## Summary
             [One sentence summary]
             ## Changes
             - [Change 1]
             - [Change 2]
          END_PROMPT
          )

          # 2. Build JSON Payload
          # Gemini structure: { contents: [{ parts: [{ text: "..." }] }] }
          jq -n \
            --arg text "$PROMPT_CONTENT" \
            '{
              contents: [{ parts: [{ text: $text }] }]
            }' > /tmp/payload.json

          # 3. Call Gemini API (FIXED MODEL NAME)
          echo "Calling Gemini API..."
          curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -s \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json \
            > /tmp/response.json

          # 4. Extract content
          CHANGELOG_TEXT=$(cat /tmp/response.json | jq -r '.candidates[0].content.parts[0].text')

          # 5. Validate Output
          if [ "$CHANGELOG_TEXT" == "null" ] || [ -z "$CHANGELOG_TEXT" ]; then
            echo "AI generation failed. Response content:"
            cat /tmp/response.json
          
            # Fallback
            cat > /tmp/changelog.md <<FALLBACK_EOF
          ## Summary
          $PR_TITLE
          ## Changes
          $PR_COMMITS
          FALLBACK_EOF
          else
            echo "AI Changelog generated successfully."
            echo "$CHANGELOG_TEXT" > /tmp/changelog.md
          fi

          # 6. Assemble Final Comment
          cat > /tmp/full_comment.md <<EOF
          # ðŸ¤– AI-Generated Changelog

          EOF
          cat /tmp/changelog.md >> /tmp/full_comment.md
          cat >> /tmp/full_comment.md <<EOF

          ---
          <sub>Generated by Google Gemini Flash (Free Tier).</sub>
          EOF

      - name: Find existing changelog comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ''

      - name: Create or update changelog comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: /tmp/full_comment.md

      - name: Save changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-pr-${{ github.event.pull_request.number }}
          path: /tmp/changelog.md
          retention-days: 30