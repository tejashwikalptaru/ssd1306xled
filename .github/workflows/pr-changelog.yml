name: AI Changelog Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

permissions:
  contents: read
  pull-requests: write

jobs:
  generate-changelog:
    name: Generate AI Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR information
        id: pr_info
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # 1. Get Commit Messages (Limit 15)
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"- %s" --no-merges | head -15)
          
          # 2. Get Changed Files (Limit 15)
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -15)
          
          # 3. Get Actual Diff (Crucial for AI accuracy)
          # We truncate to 3000 chars to avoid token limits/costs
          # We exclude lockfiles which are huge and useless to AI
          RAW_DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- . ':(exclude)package-lock.json' ':(exclude)*.lock')
          DIFF=$(echo "$RAW_DIFF" | head -c 3000)

          # Handle empty commits case
          if [ -z "$COMMITS" ]; then
            COMMITS="No commit messages found."
          fi

          # Output variables safely to GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog with AI
        id: ai_changelog
        continue-on-error: true
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # 1. Prepare Prompt Content
          # We construct the text first so we can inject it into JSON safely later
          PROMPT_CONTENT="You are a senior technical writer.
          
          Task: Write a concise changelog based on the provided Code Diff and Commits.
          
          Context:
          - PR Title: ${{ steps.pr_info.outputs.pr_title }}
          - Files: ${{ steps.pr_info.outputs.changed_files }}
          - Commits: ${{ steps.pr_info.outputs.commits }}
          
          CODE DIFF (TRUNCATED):
          ${{ steps.pr_info.outputs.diff }}
          
          Strict Rules:
          1. Do NOT hallucinate features that are not in the Code Diff.
          2. If the diff contains only CI/CD or workflow files, summarize it as 'Internal CI improvements'.
          3. Do NOT make up version numbers.
          4. Format:
             ## Summary
             [One sentence summary]
             ## Changes
             - [Change 1]
             - [Change 2]
          "

          # 2. Build JSON Payload using jq to handle special characters safely
          # This prevents the workflow from crashing if commits have quotes
          jq -n \
            --arg content "$PROMPT_CONTENT" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: "You are a helpful, factual assistant."},
                {role: "user", content: $content}
              ],
              temperature: 0.2
            }' > /tmp/payload.json

          # 3. Call OpenAI API
          echo "Calling OpenAI API..."
          curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/payload.json \
            > /tmp/response.json

          # 4. Extract content
          CHANGELOG_TEXT=$(cat /tmp/response.json | jq -r '.choices[0].message.content')

          # 5. Validate Output (Fallback if empty or null)
          if [ "$CHANGELOG_TEXT" == "null" ] || [ -z "$CHANGELOG_TEXT" ]; then
            echo "AI generation failed. Response content:"
            cat /tmp/response.json
          
            # Create Fallback File
            cat > /tmp/changelog.md << 'FALLBACK_EOF'
          ## Summary
          ${{ steps.pr_info.outputs.pr_title }}
          ## Changes
          ${{ steps.pr_info.outputs.commits }}
          FALLBACK_EOF
          else
            echo "AI Changelog generated successfully."
            echo "$CHANGELOG_TEXT" > /tmp/changelog.md
          fi

          # 6. Assemble Final Comment File (Header + Content + Footer)
          cat > /tmp/full_comment.md << 'EOF'
          # ðŸ¤– AI-Generated Changelog

          EOF
          
          cat /tmp/changelog.md >> /tmp/full_comment.md
          
          cat >> /tmp/full_comment.md << 'EOF'

          ---
          <sub>Generated by OpenAI gpt-4o-mini via GitHub Actions.</sub>
          EOF

      - name: Find existing changelog comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ''

      - name: Create or update changelog comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: /tmp/full_comment.md

      - name: Save changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-pr-${{ github.event.pull_request.number }}
          path: /tmp/changelog.md
          retention-days: 30