name: AI Changelog Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

permissions:
  contents: read
  pull-requests: write
  # models permission is usually implied by GH_TOKEN for beta users,
  # but checking your org settings is good.

jobs:
  generate-changelog:
    name: Generate AI Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install GitHub Models Extension
        run: gh extension install https://github.com/github/gh-models
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR information
        id: pr_info
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Get commits (limit to last 15 to prevent token overflow)
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"- %s" --no-merges | head -15)
          
          # Get file list
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -15)
          
          # Get stats
          DIFF_STAT=$(git diff origin/${{ github.base_ref }}...HEAD --stat | tail -1)

          # Handle empty commits case
          if [ -z "$COMMITS" ]; then
            COMMITS="No commit messages found."
          fi

          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "diff_stat=$DIFF_STAT" >> $GITHUB_OUTPUT

      - name: Generate changelog with AI
        id: ai_changelog
        continue-on-error: true
        run: |
          # 1. Create a Strict Prompt
          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          You are an automated changelog assistant. Your ONLY job is to summarize the provided Commit Messages and PR Title into a list.
          
          â›” **STRICT RULES - READ CAREFULLY:**
          1. **DO NOT** invent features.
          2. **DO NOT** make up version numbers (like v1.2.0).
          3. **DO NOT** write a generic introduction about "enhancing development experience."
          4. **ONLY** use the "Source Data" below.
          5. If the commit messages are vague, just list them as they are.

          ---
          **SOURCE DATA:**

          **Project Name:** ssd1306xled
          **PR Title:** ${{ steps.pr_info.outputs.pr_title }}

          **Changed Files:**
          ${{ steps.pr_info.outputs.changed_files }}

          **Commit Messages (The Truth):**
          ${{ steps.pr_info.outputs.commits }}

          **Diff Stats:** ${{ steps.pr_info.outputs.diff_stat }}
          ---

          **OUTPUT FORMAT (Markdown):**

          ## Summary
          [1 sentence summarizing the PR Title]

          ## ðŸ›  Changes
          - [Bullet point derived ONLY from Commit Messages]
          - [Bullet point derived ONLY from Commit Messages]

          ## ðŸ“„ Files
          - [List top 3 important files changed]

          PROMPT_EOF

          # 2. DEBUG: Print the prompt to logs so we can see what the AI sees
          echo "---------------- DEBUG: PROMPT START ----------------"
          cat /tmp/prompt.txt
          echo "---------------- DEBUG: PROMPT END ------------------"

          # 3. Call GitHub Models
          # Note: openai/gpt-4o is smarter at following strict rules than mini, 
          # but let's try mini with the strict prompt first.
          if gh models run openai/gpt-4o-mini < /tmp/prompt.txt > /tmp/changelog_raw.md 2>/tmp/ai_error.log; then
            echo "AI changelog generated successfully"
            cat /tmp/changelog_raw.md > /tmp/changelog.md
            echo "ai_success=true" >> $GITHUB_OUTPUT
          else
            echo "AI generation failed, using fallback"
            cat /tmp/ai_error.log || true
          
            # Fallback
            cat > /tmp/changelog.md << 'FALLBACK_EOF'
          ## Summary
          ${{ steps.pr_info.outputs.pr_title }}
          ## Changes
          ${{ steps.pr_info.outputs.commits }}
          FALLBACK_EOF
            echo "ai_success=false" >> $GITHUB_OUTPUT
          fi

          # 4. Assemble Full Comment
          cat > /tmp/full_comment.md << 'EOF'
          # ðŸ¤– AI-Generated Changelog

          EOF
          
          cat /tmp/changelog.md >> /tmp/full_comment.md
          
          cat >> /tmp/full_comment.md << 'EOF'

          ---
          <sub>This changelog was automatically generated using GitHub Models.</sub>
          EOF

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find existing changelog comment
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ''

      - name: Create or update changelog comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: /tmp/full_comment.md

      - name: Save changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-pr-${{ github.event.pull_request.number }}
          path: /tmp/changelog.md
          retention-days: 30